---
title: "quantex_results"
author: "Nele-Pauline Suffo"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(lme4)
library(brms)
library(lmerTest)
library(ggplot2)
library(ggthemes)
```

```{r load-data}
utterance_01a_df <- read_csv("../paper/data/utterance_01a_df.csv", show_col_types = FALSE)

utterance_01b_df <- read_csv("../paper/data/utterance_01b_df.csv", show_col_types = FALSE)

utterance_01c_df <- read_csv("../paper/data/utterance_01c_df.csv", show_col_types = FALSE)

utterance_01_df <- read_csv("../paper/data/utterance_01_df.csv", show_col_types = FALSE)
```

## Run model 1a

```{r}
# new data file for modelling
utterance_01a_df <- utterance_01a_df %>%
  mutate(play_context = factor(play_context, levels = c("alone", "social")),
         child_id = factor(child_id),
         z_age = scale(age))

# bayesian model - no convergence problems and more options for visuals

bmodel_01a <- brm(kchi_present ~ z_age * play_context + ( play_context | child_id),
               data = utterance_01a_df,
               family = bernoulli(),
               chains = 4, 
               cores = 4,
               iter = 2000,
               #threads = threading(8), # to speed things up wehn on a cluster
               #backend = "cmdstanr", # to speed things up wehn on a cluster
               #control = list(adapt_delta = 0.95, max_treedepth = 20) # control option in case of nonconvergence of chains
    )%>%add_criterion("loo") # add loo for model comparison

```
## Visuals 1a

```{r}
ndata1a <- m_utterance_01a_df%>%
  distinct(z_age, age, play_context ) # generate new data set for which we want to generate predictions based on the model, this does not include child because we want the "average" or "marginal" predicitons, that is, average developmental trajectory for each play context. We need age in there for plotting


post1a <- fitted(bmodel_01a, newdata = ndata1a, re_formula = NA)%>%
  as_tibble() %>%
  bind_cols(ndata1a)

ggplot()+
  geom_smooth(data = post1a, aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill =play_context, col = play_context), stat = "identity", alpha = .25)+ # plot the predicted trajectories
  theme_bw()+
  scale_color_ptol(name = "Play context")+
  scale_fill_ptol(name = "Play context")+
  ylim(0,1)+
  labs(x = "Age in years", y="Probability of key child utterance being present")+
  theme(
    #legend.position = c(0.8, 0.15), 
    legend.background = element_rect(colour = "black", size = 0.5, linetype = "solid"))
```
 ## Model 1b
```{r}
# new data file for modelling
utterance_01b_df <- utterance_01b_df %>%
  mutate(across(starts_with("object_class"), factor),
         child_id = factor(child_id),
         z_age = scale(age))

# bayesian model - no convergence problems and more options for visuals

bmodel_01b <- brm(kchi_present ~ z_age * object_class + ( object_class | child_id),
               data = utterance_01b_df,
               family = bernoulli(),
               chains = 4, 
               cores = 4,
               iter = 2000,
               #threads = threading(8), # to speed things up wehn on a cluster
               #backend = "cmdstanr", # to speed things up wehn on a cluster
               #control = list(adapt_delta = 0.95, max_treedepth = 20) # control option in case of nonconvergence of chains
    )%>%add_criterion("loo") # add loo for model comparison

```

# Model 1c

## Run model

```{r}
utterance_01c_df <- utterance_01_df%>%
    filter(play_context == "social")%>%
    mutate(child_id = factor(child_id),
           gaze = factor(gaze_direction, levels = c("none", "1.0", "0.0"), labels = c("na", "yes", "no")),
           z_age = scale(age)
        )

bmodel_01c <- brm(kchi_present ~ z_age * person_age_class * face_present + (1 | child_id), # remove random slopes within child just because it takes long to run them, bring them back later; also need to remove some variables becasue too little data
               data = utterance_01c_df,
               family = bernoulli(),
               chains = 4, 
               cores = 4,
               iter = 5000,
               #threads = threading(8), # to speed things up wehn on a cluster
               #backend = "cmdstanr", # to speed things up wehn on a cluster
               control = list(adapt_delta = 0.95, max_treedepth = 20) # control option in case of nonconvergence of chains
    )%>%add_criterion("loo") # add loo for model comparison


bmodel_01c
```

## visuals

```{r}
ndata1c <- m_utterance_01c_df%>%
  distinct(z_age, age, person_age_class,  close_face_present_text ) # generate new data set for which we want to generate predictions based on the model, this does not include child because we want the "average" or "marginal" predicitons, that is, average developmental trajectory for each play context. We need age in there for plotting


post1c <- fitted(bmodel_01c, newdata = ndata1c, re_formula = NA)%>%
  as_tibble() %>%
  bind_cols(ndata1c)

ggplot()+
  geom_smooth(data = post1c, aes(x = age, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill =close_face_present_text, col = close_face_present_text), stat = "identity", alpha = .25)+ # plot the predicted trajectories
  theme_bw()+
  scale_color_ptol(name = "Face present")+
  scale_fill_ptol(name = "Face present")+
  ylim(0,1)+
  facet_grid(~ person_age_class) # use when there are more variables 
  labs(x = "Age in years", y="Probability of key child utterance being present")+
  theme(
    #legend.position = c(0.8, 0.15), 
    legend.background = element_rect(colour = "black", size = 0.5, linetype = "solid"))
```

